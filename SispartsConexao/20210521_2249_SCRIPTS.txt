
'' 02.01.CARREGAR ITENS DE COMPRAS ANTES DE ENVIAR PARA O SERVIDOR
Public Function carregar_ComprasItens(pPathFile As String)
On Error Resume Next

'' CHAVES DE CONTROLE
Dim pPK As String: pPK = DLookup("[Chave]", "[tblDadosConexaoNFeCTe]", "[CaminhoDoArquivo]='" & pPathFile & "'")
Dim pChvAcesso As String: pChvAcesso = DLookup("[ChvAcesso]", "[tblDadosConexaoNFeCTe]", "[CaminhoDoArquivo]='" & pPathFile & "'")

'' controle do xml
Dim XDoc As Object: Set XDoc = CreateObject("MSXML2.DOMDocument"): XDoc.async = False: XDoc.validateOnParse = False
XDoc.Load pPathFile

Dim cont As Integer: cont = XDoc.getElementsByTagName("infNFe/det").Length
Dim Item As Variant

Dim pDados As New Collection

Dim idItem As String: idItem = ""

   '' LIMPAR TABELA DE PROCESSAMENTOS
'    Application.CurrentDb.Execute qryDeleteProcessamento

   '' IDENTIFICAÇÃO DO ARQUIVO
   pDados.add pPK & "|" & "CaminhoDoArquivo" & "|" & pPathFile

   '' CHAVE DE ACESSO
   pDados.add pPK & "|" & "ChvAcesso_CompraNF" & "|" & pChvAcesso

   For i = 0 To cont - 1
       '' ID
       idItem = CStr(XDoc.getElementsByTagName("nfeProc/NFe/infNFe/det").Item(i).Attributes(0).value)
       pDados.add pPK & "_" & idItem & "|" & "Item_CompraNFItem" & "|" & idItem
       pDados.add pPK & "_" & idItem & "|" & "ChvAcesso_CompraNF" & "|" & pChvAcesso

       '' CAMPOS DO REGISTRO
       For Each Item In carregarParametros(qryTags, "tblCompraNFItem")
           pDados.add pPK & "_" & idItem & "|" & Item & "|" & XDoc.SelectNodes("nfeProc/NFe/infNFe/det").Item(i).SelectNodes(Item).Item(0).text
       Next Item

       DoEvents

   Next i

   '' CADASTRAR DADOS
   cadastroProcessamento pDados

   '' LIMPAR COLEÇÃO
   ClearCollection pDados

   '' ATUALIZAR CAMPOS DE RELACIONAMENTOS
   Application.CurrentDb.Execute Replace(qryUpdateProcessamento, "strParametro", "tblCompraNFItem")

   '' TRANSFERIR PROCESSADOS
   TransferirDadosProcessados "tblCompraNFItem"

Set XDoc = Nothing

End Function

Public Function carregar_ComprasItensPorConsulta()
On Error Resume Next

Dim pPK As String
Dim pChvAcesso As String

Dim cont As Integer
Dim Item As Variant

Dim pDados As New Collection

Dim idItem As String

'' controle do xml
Dim XDoc As Object: Set XDoc = CreateObject("MSXML2.DOMDocument"): XDoc.async = False: XDoc.validateOnParse = False

Dim tPathFile As Variant

Dim contadorDeArquivos As Long: contadorDeArquivos = 1

'' LIMPAR TABELA DE PROCESSAMENTOS
Application.CurrentDb.Execute qryDeleteProcessamento

SysCmd acSysCmdInitMeter, "Processando Itens...", DCount("*", "tblDadosConexaoNFeCTe", "(((tblDadosConexaoNFeCTe.registroValido)=1) AND ((tblDadosConexaoNFeCTe.registroProcessado)=1) AND ((tblDadosConexaoNFeCTe.ID_Tipo)>0))")

For Each tPathFile In carregarParametros(qrySelectProcessamentoItensCompras)

   '' #BARRA_PROGRESSO
   SysCmd acSysCmdUpdateMeter, contadorDeArquivos

   '' CHAVES DE CONTROLE
   pPK = DLookup("[Chave]", "[tblDadosConexaoNFeCTe]", "[CaminhoDoArquivo]='" & CStr(tPathFile) & "'")
   pChvAcesso = DLookup("[ChvAcesso]", "[tblDadosConexaoNFeCTe]", "[CaminhoDoArquivo]='" & CStr(tPathFile) & "'")

   '' CARREGAR ARQUIVO
   XDoc.Load CStr(tPathFile)

   '' CONTADOR DE REGISTROS
   cont = XDoc.getElementsByTagName("infNFe/det").Length

   idItem = ""

   '' IDENTIFICAÇÃO DO ARQUIVO
   pDados.add pPK & "|" & "CaminhoDoArquivo" & "|" & CStr(tPathFile)

   '' CHAVE DE ACESSO
   pDados.add pPK & "|" & "ChvAcesso_CompraNF" & "|" & pChvAcesso

   For i = 0 To cont - 1
       '' ID
       idItem = CStr(XDoc.getElementsByTagName("nfeProc/NFe/infNFe/det").Item(i).Attributes(0).value)
       pDados.add pPK & "_" & idItem & "|" & "Item_CompraNFItem" & "|" & idItem
       pDados.add pPK & "_" & idItem & "|" & "ChvAcesso_CompraNF" & "|" & pChvAcesso

       '' CAMPOS DO REGISTRO
       For Each Item In carregarParametros(qryTags, "tblCompraNFItem")
           pDados.add pPK & "_" & idItem & "|" & Item & "|" & XDoc.SelectNodes("nfeProc/NFe/infNFe/det").Item(i).SelectNodes(Item).Item(0).text
       Next Item

       DoEvents

   Next i

   '' CADASTRAR DADOS
   cadastroProcessamento pDados

   '' LIMPAR COLEÇÃO
   ClearCollection pDados

   Set XDoc = Nothing

   '' #BARRA_PROGRESSO
   contadorDeArquivos = contadorDeArquivos + 1

   '' ATUALIZAR CAMPOS DE RELACIONAMENTOS
   Application.CurrentDb.Execute Replace(qryUpdateProcessamento, "strParametro", "tblCompraNFItem")

Next tPathFile

'' #BARRA_PROGRESSO
SysCmd acSysCmdRemoveMeter

End Function

'' 02.CARREGAR COMPRAS ANTES DE ENVIAR PARA O SERVIDOR
Public Function carregar_Compras()
Dim strProcessamento As String: strProcessamento = "tblCompraNF"
Dim s As New clsConexaoNfeCte
Dim t As Variant

On Error GoTo adm_Err
Dim retVal As Variant: retVal = MsgBox("Deseja carregar as compras com base no processamento de dados gerais ?", vbQuestion + vbYesNo, "carregarCompras")

   If retVal = vbYes Then

       '' #CARREGAR DADOS
       '' PROCESSAR APENAS ARQUIVOS VALIDOS
       ProcessarArquivosXml strProcessamento, carregarParametros(qrySelectProcessamentoPendente)

       '' FORMATAR CAMPOS
       FormatarCamposEmProcessamento

       '' #TRATAMENTO
       TratamentoDeCompras

       '' #TRANSFERIR DADOS PROCESSADOS - COMPRAS
       TransferirDadosProcessados strProcessamento

       '' ATUALIZAR CAMPOS DE COMPRAS
       compras_atualizarCampos

       '' CARREGAR ITENS CTE
       compras_carregarItensCTe


       '' CARREGAR ITENS GERAIS
       For Each t In carregarParametros(qrySelectProcessamentoPendente)
           Debug.Print CStr(t)
           carregar_ComprasItens CStr(t)
       Next t

       '' USAR APOS PROCESSAR ITENS DE COMPRA
       ' compras_atualizarItensCompras

       '' #VALIDAR_DADOS
       ' criarConsultasParaTestes

'        MsgBox "Fim!", vbOKOnly + vbExclamation, "carregarCompras"

   End If

adm_Exit:
   Exit Function

adm_Err:
   MsgBox Error$
   Resume adm_Exit

End Function