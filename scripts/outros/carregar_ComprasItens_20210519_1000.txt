Public Function carregar_ComprasItens(pPathFile As String)
On Error Resume Next

Dim s As New clsConexaoNfeCte

'' CHAVES DE CONTROLE
Dim pPK As String: pPK = DLookup("[Chave]", "[tblDadosConexaoNFeCTe]", "[CaminhoDoArquivo]='" & pPathFile & "'")
Dim pChvAcesso As String: pChvAcesso = DLookup("[ChvAcesso]", "[tblDadosConexaoNFeCTe]", "[CaminhoDoArquivo]='" & pPathFile & "'")

'' CARREGAR ARQUIVO
Dim XDoc As Object: Set XDoc = CreateObject("MSXML2.DOMDocument"): XDoc.async = False: XDoc.validateOnParse = False
XDoc.Load pPathFile

Dim cont As Integer: cont = XDoc.getElementsByTagName("infNFe/det").Length
Dim Item As Variant

Dim pDados As New Collection

Dim idItem As String: idItem = ""

    '' LIMPAR TABELA DE PROCESSAMENTOS
    Application.CurrentDb.Execute qryDeleteProcessamento

    '' IDENTIFICAÇÃO DO ARQUIVO
    pDados.add pPK & "|" & "CaminhoDoArquivo" & "|" & pPathFile

    '' CHAVE DE ACESSO
    pDados.add pPK & "|" & "ChvAcesso_CompraNF" & "|" & pChvAcesso

    
    '' CABEÇALHO DA COMPRA
    '' ID
    idItem = CStr(XDoc.getElementsByTagName("nfeProc/NFe/infNFe/det").Item(i).Attributes(0).value)
    pDados.add pPK & "_" & idItem & "|" & "Item_CompraNFItem" & "|" & idItem
    pDados.add pPK & "_" & idItem & "|" & "ChvAcesso_CompraNF" & "|" & pChvAcesso
    
    For Each Item In carregarParametros(qryCamposCompra, "tblCompraNFItem")
        Select Case UBound(Split((Item), "|"))
            
            '' ITEM DE COMPRA
            Case 1
                regiao = Split((Item), "|")(0)
                campo = Split((Item), "|")(1)
                pDados.add pPK & "_" & idItem & "|" & Item & "|" & XDoc.SelectNodes(regiao).Item(i).SelectNodes(campo).Item(0).text
            
            '' IMPOSTO
            Case 2
                regiao = Split((Item), "|")(0)
                subRegiao = Split((Item), "|")(1)
                campo = Split((Item), "|")(2)
                pDados.add pPK & "_" & idItem & "|" & Item & "|" & XDoc.SelectNodes(regiao).Item(i).SelectNodes(subRegiao).Item(0).getElementsByTagName(campo).Item(0).text
            Case Else
        End Select
            
        


        '' ITENS DA COMPRA
        For Each Item In carregarParametros(qryTags, "tblCompraNFItem")
            Select Case UBound(Split((Item), "|"))
                
                '' ITEM DE COMPRA
                Case 1
                    regiao = Split((Item), "|")(0)
                    campo = Split((Item), "|")(1)
                    pDados.add pPK & "_" & idItem & "|" & Item & "|" & XDoc.SelectNodes(regiao).Item(i).SelectNodes(campo).Item(0).text
                
                '' IMPOSTO
                Case 2
                    regiao = Split((Item), "|")(0)
                    subRegiao = Split((Item), "|")(1)
                    campo = Split((Item), "|")(2)
                    pDados.add pPK & "_" & idItem & "|" & Item & "|" & XDoc.SelectNodes(regiao).Item(i).SelectNodes(subRegiao).Item(0).getElementsByTagName(campo).Item(0).text
                Case Else
            End Select
        Next Item

        DoEvents

    Next i

    '' CADASTRAR DADOS
    s.cadastroProcessamento pDados
    
    '' LIMPAR COLEÇÃO
    ClearCollection pDados

    '' ATUALIZAR CAMPOS DE RELACIONAMENTOS
    Application.CurrentDb.Execute Replace(qryUpdateProcessamento, "strParametro", "tblCompraNFItem")
    
    '' TRANSFERIR PROCESSADOS
'    s.TransferirDadosProcessados "tblCompraNFItem"

Set XDoc = Nothing

End Function